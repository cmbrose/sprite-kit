name: Example - VSCode Build

on:
  workflow_dispatch:
    inputs:
      force_failure_step:
        description: 'Which step should fail on first attempt? (setup/install/build/test/none)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - setup
          - install
          - build
          - test

env:
  SPRITES_TOKEN: ${{ secrets.SPRITES_TOKEN }}

jobs:
  vscode-build:
    name: VSCode Build Demo
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: ğŸš€ Initialize Sprite
        uses: ./init

      - name: ğŸ“¥ Clone VSCode Repository
        uses: ./run
        with:
          run: |
            set -e

            echo "ğŸ”„ Cloning microsoft/vscode repository..."
            
            # Clone the repository
            git clone --depth=1 --single-branch --branch=main https://github.com/microsoft/vscode.git
            cd vscode
            
            echo "âœ… Clone completed successfully!"
            echo "ğŸ“ Cloned commit: $(git rev-parse --short HEAD)"
            echo "ğŸ“‚ Repository size: $(du -sh . | cut -f1)"

      - name: âš™ï¸ Setup Node.js
        uses: ./run
        with:
          run: |
            set -e

            echo "ğŸ”§ Setting up Node.js v22.21.1 using nvm..."
            
            # Install and use Node.js v22.21.1 via nvm
            # Sprites has a sneaky nvm installation, which seems to break standard nvm installs, so we have to use it...
            export NVM_DIR="/.sprite/languages/node/nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            nvm install 22.21.1
            nvm use 22.21.1
            nvm alias default 22.21.1
            
            # Verify installation
            node --version
            npm --version
            echo "âœ… Node.js v22.21.1 installed and activated via nvm!"

      - name: Install System Dependencies
        uses: ./run
        with:
          run: |
            set -e

            echo "ğŸ”§ Installing system dependencies for VSCode..."
            
            # Simulate failure if requested
            if [ "${{ github.event.inputs.force_failure_step }}" = "setup" ] && [ "${{ github.run_attempt }}" = "1" ]; then
              echo "ğŸ’¥ SIMULATED FAILURE: Setup failing on first attempt (as requested)"
              exit 1
            fi

            sudo apt-get update
            sudo apt-get install -y \
              build-essential \
              g++ \
              libx11-dev \
              libxkbfile-dev \
              libsecret-1-dev \
              libkrb5-dev \
              python-is-python3
            
            echo "âœ… System dependencies installed successfully!"

      - name: ğŸ“¦ Install NPM Dependencies  
        uses: ./run
        with:
          workdir: vscode
          run: |
            set -e

            # Simulate failure if requested
            if [ "${{ github.event.inputs.force_failure_step }}" = "install" ] && [ "${{ github.run_attempt }}" = "1" ]; then
              echo "ğŸ’¥ SIMULATED FAILURE: Install failing on first attempt (as requested)"
              exit 1
            fi

            echo "ğŸ“¦ Installing NPM dependencies..."
            
            # Install dependencies
            echo "â¬‡ï¸  Running npm install..."
            npm install --no-audit --no-fund
            
            echo "âœ… NPM dependencies installed successfully!"
            echo "ğŸ“Š node_modules size: $(du -sh node_modules | cut -f1)"
            echo "ğŸ“¦ Total packages: $(find node_modules -name 'package.json' | wc -l)"

      - name: ğŸ—ï¸ Build VSCode Core
        uses: ./run
        with:
          workdir: vscode
          run: |
            set -e

            echo "ğŸ—ï¸ Building VSCode core components..."
            
            # Simulate failure if requested
            if [ "${{ github.event.inputs.force_failure_step }}" = "build" ] && [ "${{ github.run_attempt }}" = "1" ]; then
              echo "ğŸ’¥ SIMULATED FAILURE: Build failing on first attempt (as requested)"
              exit 1
            fi
            
            # Build the project
            echo "âš™ï¸  Running build process..."
            npm run compile
            
            echo "âœ… Build completed successfully!"
            if [ -d "out" ]; then
              echo "ğŸ“Š Build output size: $(du -sh out | cut -f1)"
            fi

      - name: ğŸ§ª Run Basic Tests
        uses: ./run
        with:
          workdir: vscode
          run: |
            echo "ğŸ§ª Running basic VSCode tests..."
            
            # Simulate failure if requested
            if [ "${{ github.event.inputs.force_failure_step }}" = "test" ] && [ "${{ github.run_attempt }}" = "1" ]; then
              echo "ğŸ’¥ SIMULATED FAILURE: Tests failing on first attempt (as requested)"
              exit 1
            fi
            
            # Run a subset of fast tests
            echo "ğŸƒâ€â™‚ï¸ Running unit tests..."
            npm run test-node
            
            echo "âœ… Basic tests completed!"

      # Only cleanup on success - if we cleanup on failure, 
      # the sprite won't exist for retry to restore from
      - name: ğŸ§¹ Cleanup Sprite
        if: success()
        uses: ./clean