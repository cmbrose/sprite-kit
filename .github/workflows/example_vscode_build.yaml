name: Example - Large Scale VSCode Build

on:
  workflow_dispatch:
    inputs:
      force_failure_step:
        description: 'Which step should fail on first attempt? (setup/build/test/none)'
        required: false
        default: 'none'
        type: choice
        options:
          - none
          - setup
          - build
          - test

env:
  SPRITES_TOKEN: ${{ secrets.SPRITES_TOKEN }}

jobs:
  vscode-build:
    name: VSCode Build Demo
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - uses: actions/checkout@v4

      - name: ğŸš€ Initialize Sprite
        id: init
        uses: ./init

      - name: ğŸ“Š Show Sprite Info
        run: |
          echo "ğŸ¯ Sprite Name: ${{ steps.init.outputs.sprite-name }}"
          echo "ğŸ”‘ Job Key: ${{ steps.init.outputs.job-key }}"
          echo "ğŸ†” Run ID: ${{ steps.init.outputs.run-id }}"
          echo "ğŸ”„ Needs Restore: ${{ steps.init.outputs.needs-restore }}"
          
          if [ "${{ steps.init.outputs.needs-restore }}" = "true" ]; then
            echo "âœ¨ This is a retry! The sprite will restore previous progress."
          else
            echo "ğŸ†• This is a fresh run. Building from scratch."
          fi

      - name: ğŸ“¥ Clone VSCode Repository
        id: clone
        uses: ./run
        with:
          step-key: clone-vscode
          run: |
            echo "ğŸ”„ Cloning microsoft/vscode repository..."
            
            # Clone the repository
            git clone --depth=1 --single-branch --branch=main https://github.com/microsoft/vscode.git
            cd vscode
            
            echo "âœ… Clone completed successfully!"
            echo "ğŸ“ Cloned commit: $(git rev-parse --short HEAD)"
            echo "ğŸ“‚ Repository size: $(du -sh . | cut -f1)"

      - name: ğŸ“¦ Setup Dependencies  
        id: setup
        uses: ./run
        with:
          step-key: setup-deps
          workdir: vscode
          run: |
            echo "ğŸ“¦ Installing VSCode dependencies..."
            
            # Simulate failure if requested
            if [ "${{ github.event.inputs.force_failure_step }}" = "setup" ] && [ "${{ github.run_attempt }}" = "1" ]; then
              echo "ğŸ’¥ SIMULATED FAILURE: Setup failing on first attempt (as requested)"
              echo "ğŸ”„ On retry, this step will be skipped entirely due to checkpointing!"
              exit 1
            fi
            
            # Install dependencies
            echo "â¬‡ï¸  Running npm install..."
            npm install --no-audit --no-fund
            
            echo "âœ… Dependencies installed successfully!"
            echo "ğŸ“Š node_modules size: $(du -sh node_modules | cut -f1)"
            echo "ğŸ“¦ Total packages: $(find node_modules -name 'package.json' | wc -l)"

      - name: ğŸ—ï¸ Build VSCode Core
        id: build
        uses: ./run
        with:
          step-key: build-core
          workdir: vscode
          run: |
            echo "ğŸ—ï¸ Building VSCode core components..."
            
            # Simulate failure if requested
            if [ "${{ github.event.inputs.force_failure_step }}" = "build" ] && [ "${{ github.run_attempt }}" = "1" ]; then
              echo "ğŸ’¥ SIMULATED FAILURE: Build failing on first attempt (as requested)"
              echo "ğŸ”„ On retry, setup steps will be skipped and build will retry!"
              exit 1
            fi
            
            # Build the project
            echo "âš™ï¸  Running build process..."
            npm run compile
            
            echo "âœ… Build completed successfully!"
            if [ -d "out" ]; then
              echo "ğŸ“Š Build output size: $(du -sh out | cut -f1)"
            fi

      - name: ğŸ§ª Run Basic Tests
        id: test
        uses: ./run
        with:
          step-key: run-tests
          workdir: vscode
          run: |
            echo "ğŸ§ª Running basic VSCode tests..."
            
            # Simulate failure if requested
            if [ "${{ github.event.inputs.force_failure_step }}" = "test" ] && [ "${{ github.run_attempt }}" = "1" ]; then
              echo "ğŸ’¥ SIMULATED FAILURE: Tests failing on first attempt (as requested)"
              echo "ğŸ”„ On retry, all previous steps will be skipped and only tests will re-run!"
              exit 1
            fi
            
            # Run a subset of fast tests
            echo "ğŸƒâ€â™‚ï¸ Running unit tests..."
            npm run test:unit -- --grep "basic" --timeout 30000 || true
            
            # Just check that critical files exist
            echo "ğŸ” Verifying build artifacts..."
            test -f "out/bootstrap.js" || { echo "âŒ Bootstrap not found"; exit 1; }
            test -d "out/vs" || { echo "âŒ VS directory not found"; exit 1; }
            
            echo "âœ… Basic tests completed!"

      - name: ğŸ“ˆ Show Final Stats
        uses: ./run
        with:
          step-key: show-stats
          workdir: vscode
          run: |
            echo "ğŸ“ˆ Final Build Statistics:"
            echo "=========================================="
            echo "ğŸ“‚ Repository: $(du -sh . | cut -f1)"
            echo "ğŸ“¦ Dependencies: $(du -sh node_modules 2>/dev/null | cut -f1 || echo 'N/A')"
            echo "ğŸ—ï¸ Build Output: $(du -sh out 2>/dev/null | cut -f1 || echo 'N/A')"
            echo "ğŸ“„ Total Files: $(find . -type f | wc -l)"
            echo "â±ï¸ Build completed at: $(date)"
            echo "=========================================="

      - name: ğŸ“Š Show Step Results
        if: always()
        run: |
          echo "ğŸ¯ Sprite Kit Demo Results:"
          echo "================================="
          echo "Clone - Skipped: ${{ steps.clone.outputs.skipped }}, Exit Code: ${{ steps.clone.outputs.exit-code }}"
          echo "Setup - Skipped: ${{ steps.setup.outputs.skipped }}, Exit Code: ${{ steps.setup.outputs.exit-code }}"
          echo "Build - Skipped: ${{ steps.build.outputs.skipped }}, Exit Code: ${{ steps.build.outputs.exit-code }}"
          echo "Tests - Skipped: ${{ steps.test.outputs.skipped }}, Exit Code: ${{ steps.test.outputs.exit-code }}"
          echo "================================="
          
          if [ "${{ github.run_attempt }}" != "1" ]; then
            echo "ğŸ”„ This was a RETRY run - notice how expensive steps were skipped!"
            echo "ğŸ’¾ Sprite Kit saved significant time by preserving state across steps."
          else
            echo "ğŸ†• This was the initial run - all steps executed from scratch."
            if [ "${{ github.event.inputs.force_failure_step }}" != "none" ]; then
              echo "ğŸ’¥ Failure was simulated in the ${{ github.event.inputs.force_failure_step }} step."
              echo "ğŸ”„ Try re-running this workflow to see the retry behavior!"
            fi
          fi

      # Only cleanup on success - if we cleanup on failure, 
      # the sprite won't exist for retry to restore from
      - name: ğŸ§¹ Cleanup Sprite
        if: success()
        uses: ./clean