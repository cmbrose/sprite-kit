name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SPRITES_TOKEN: ${{ secrets.SPRITES_TOKEN }}

jobs:
  # Basic smoke test to verify actions can be loaded and initialized
  smoke-test:
    name: Smoke Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build actions
        run: npm install && npm run build

      - name: Test Init Action
        id: init
        uses: ./src/init

      - name: Verify init outputs
        run: |
          echo "Sprite Name: ${{ steps.init.outputs.sprite-name }}"
          echo "Job Key: ${{ steps.init.outputs.job-key }}"
          echo "Run ID: ${{ steps.init.outputs.run-id }}"

          # Verify outputs are set
          test -n "${{ steps.init.outputs.sprite-name }}" || exit 1
          test -n "${{ steps.init.outputs.job-key }}" || exit 1
          test -n "${{ steps.init.outputs.run-id }}" || exit 1

      - name: Test Run Action
        id: run-test
        uses: ./src/run
        with:
          step-key: smoke-test
          run: echo "Hello from smoke test"

      - name: Verify run outputs
        run: |
          echo "Exit Code: ${{ steps.run-test.outputs.exit-code }}"
          echo "Checkpoint ID: ${{ steps.run-test.outputs.checkpoint-id }}"

          test "${{ steps.run-test.outputs.exit-code }}" = "0" || exit 1
          test -n "${{ steps.run-test.outputs.checkpoint-id }}" || exit 1

      - name: Test Clean Action
        uses: ./src/clean