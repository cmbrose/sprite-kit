name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  SPRITES_TOKEN: ${{ secrets.SPRITES_TOKEN }}

jobs:
  # Test 1: Basic workflow with init + multiple run steps
  basic-workflow:
    name: Basic Workflow
    runs-on: ubuntu-latest
    if: ${{ env.SPRITES_TOKEN != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Init Sprite
        id: init
        uses: ./init

      - name: Verify init outputs
        run: |
          echo "Sprite Name: ${{ steps.init.outputs.sprite-name }}"
          echo "Sprite ID: ${{ steps.init.outputs.sprite-id }}"
          echo "Job Key: ${{ steps.init.outputs.job-key }}"
          echo "Run ID: ${{ steps.init.outputs.run-id }}"

          # Verify outputs are set
          test -n "${{ steps.init.outputs.sprite-name }}" || exit 1
          test -n "${{ steps.init.outputs.sprite-id }}" || exit 1
          test -n "${{ steps.init.outputs.job-key }}" || exit 1
          test -n "${{ steps.init.outputs.run-id }}" || exit 1

      - name: Step 1 - Echo test
        id: step1
        uses: ./run
        with:
          step-key: echo-test
          run: echo "Hello from step 1"

      - name: Verify step 1 outputs
        run: |
          echo "Skipped: ${{ steps.step1.outputs.skipped }}"
          echo "Checkpoint ID: ${{ steps.step1.outputs.checkpoint-id }}"
          echo "Exit Code: ${{ steps.step1.outputs.exit-code }}"

          test "${{ steps.step1.outputs.exit-code }}" = "0" || exit 1
          test -n "${{ steps.step1.outputs.checkpoint-id }}" || exit 1

      - name: Step 2 - Multi-line command
        id: step2
        uses: ./run
        with:
          step-key: multiline-test
          run: |
            echo "Line 1"
            echo "Line 2"
            echo "Line 3"

      - name: Step 3 - Environment variable test
        id: step3
        uses: ./run
        with:
          step-key: env-test
          run: |
            echo "Testing environment"
            pwd
            whoami

      - name: Cleanup Sprite
        if: always()
        uses: ./cleanup
        with:
          sprite-id: ${{ steps.init.outputs.sprite-id }}

  # Test 2: Matrix job to verify unique sprite identity per matrix combination
  matrix-workflow:
    name: Matrix Workflow
    runs-on: ubuntu-latest
    if: ${{ env.SPRITES_TOKEN != '' }}
    strategy:
      matrix:
        variant: [a, b]
    steps:
      - uses: actions/checkout@v4

      - name: Init Sprite
        id: init
        uses: ./init
        with:
          matrix: ${{ toJson(matrix) }}

      - name: Verify unique sprite name contains matrix hash
        run: |
          SPRITE_NAME="${{ steps.init.outputs.sprite-name }}"
          echo "Sprite name for variant ${{ matrix.variant }}: $SPRITE_NAME"

          # Sprite name should end with a hash when matrix is provided
          if [[ ! "$SPRITE_NAME" =~ -[a-f0-9]{8}$ ]]; then
            echo "ERROR: Sprite name should contain matrix hash suffix"
            exit 1
          fi

      - name: Run step specific to matrix variant
        id: step1
        uses: ./run
        with:
          step-key: variant-step
          run: echo "Running variant ${{ matrix.variant }}"

      - name: Cleanup Sprite
        if: always()
        uses: ./cleanup
        with:
          sprite-id: ${{ steps.init.outputs.sprite-id }}

  # Test 3: Verify workdir functionality
  workdir-test:
    name: Workdir Test
    runs-on: ubuntu-latest
    if: ${{ env.SPRITES_TOKEN != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Init Sprite
        id: init
        uses: ./init

      - name: Create directory and file
        uses: ./run
        with:
          step-key: create-dir
          run: |
            mkdir -p /tmp/testdir
            echo "test content" > /tmp/testdir/testfile.txt

      - name: Verify workdir option
        uses: ./run
        with:
          step-key: check-workdir
          workdir: /tmp/testdir
          run: |
            pwd
            cat testfile.txt

      - name: Cleanup Sprite
        if: always()
        uses: ./cleanup
        with:
          sprite-id: ${{ steps.init.outputs.sprite-id }}

  # Test 4: Error handling - command failure should not create checkpoint
  error-handling:
    name: Error Handling
    runs-on: ubuntu-latest
    if: ${{ env.SPRITES_TOKEN != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Init Sprite
        id: init
        uses: ./init

      - name: Successful step
        id: success-step
        uses: ./run
        with:
          step-key: success
          run: echo "This should succeed"

      - name: Failing step (expected)
        id: fail-step
        uses: ./run
        continue-on-error: true
        with:
          step-key: failure
          run: exit 1

      - name: Verify failure was captured
        run: |
          echo "Exit code: ${{ steps.fail-step.outputs.exit-code }}"

          # Should have non-zero exit code
          test "${{ steps.fail-step.outputs.exit-code }}" = "1" || exit 1

          # Should not have created a checkpoint
          test -z "${{ steps.fail-step.outputs.checkpoint-id }}" || test "${{ steps.fail-step.outputs.checkpoint-id }}" = "" || exit 1

      - name: Cleanup Sprite
        if: always()
        uses: ./cleanup
        with:
          sprite-id: ${{ steps.init.outputs.sprite-id }}

  # Test 5: Cleanup action test
  cleanup-test:
    name: Cleanup Action Test
    runs-on: ubuntu-latest
    if: ${{ env.SPRITES_TOKEN != '' }}
    steps:
      - uses: actions/checkout@v4

      - name: Init Sprite
        id: init
        uses: ./init

      - name: Run a step
        uses: ./run
        with:
          step-key: test
          run: echo "Test"

      - name: Cleanup specific sprite
        uses: ./cleanup
        with:
          sprite-id: ${{ steps.init.outputs.sprite-id }}

      - name: Verify cleanup completed
        run: echo "Cleanup completed successfully"
